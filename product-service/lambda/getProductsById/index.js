"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.handler = void 0;
const logger_1 = require("@aws-lambda-powertools/logger");
const metrics_1 = require("@aws-lambda-powertools/metrics");
const client_dynamodb_1 = require("@aws-sdk/client-dynamodb");
const lib_dynamodb_1 = require("@aws-sdk/lib-dynamodb");
const logger = new logger_1.Logger({
    serviceName: 'productService',
    logLevel: 'INFO'
});
const metrics = new metrics_1.Metrics({
    namespace: 'ProductsApp',
    serviceName: 'productService',
    defaultDimensions: {
        environment: process.env.ENVIRONMENT || 'development'
    }
});
const client = new client_dynamodb_1.DynamoDBClient({
    region: process.env.REGION
});
const docClient = lib_dynamodb_1.DynamoDBDocumentClient.from(client);
const createResponse = (statusCode, body) => ({
    statusCode,
    headers: {
        'Access-Control-Allow-Origin': '*',
        'Access-Control-Allow-Credentials': true,
    },
    body: JSON.stringify(body)
});
const handler = async (event) => {
    logger.addContext(event);
    const productId = event.pathParameters?.id;
    try {
        logger.info('Getting product by ID', {
            operation: 'getProductById',
            productId
        });
        metrics.addMetric('getProductByIdInvocations', metrics_1.MetricUnit.Count, 1);
        if (!productId) {
            logger.error('Missing product ID');
            metrics.addMetric('missingProductIdErrors', metrics_1.MetricUnit.Count, 1);
            return createResponse(400, { message: 'Missing product ID' });
        }
        // Get product
        const productParams = {
            TableName: process.env.PRODUCTS_TABLE,
            Key: { id: productId }
        };
        const productCommand = new lib_dynamodb_1.GetCommand(productParams);
        const productResponse = await docClient.send(productCommand);
        if (!productResponse.Item) {
            logger.info('Product not found', { productId });
            metrics.addMetric('productNotFound', metrics_1.MetricUnit.Count, 1);
            return createResponse(404, {
                message: 'Product not found'
            });
        }
        // Get stock
        const stockParams = {
            TableName: process.env.STOCKS_TABLE,
            Key: { product_id: productId }
        };
        const stockCommand = new lib_dynamodb_1.GetCommand(stockParams);
        const stockResponse = await docClient.send(stockCommand);
        const product = productResponse.Item;
        const stock = stockResponse.Item;
        const response = {
            ...product,
            count: stock?.count || 0
        };
        logger.info('Successfully retrieved product', {
            productId,
            hasStock: !!stock
        });
        metrics.addMetric('successfulProductRetrieval', metrics_1.MetricUnit.Count, 1);
        return createResponse(200, response);
    }
    catch (error) {
        logger.error('Error getting product', {
            productId,
            error: error.message,
            errorName: error.name,
            stackTrace: error.stack
        });
        metrics.addMetric('productRetrievalErrors', metrics_1.MetricUnit.Count, 1);
        return createResponse(500, {
            message: 'Internal server error while fetching product',
            error: process.env.IS_OFFLINE ? error.message : 'Internal server error'
        });
    }
    finally {
        metrics.publishStoredMetrics();
    }
};
exports.handler = handler;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJpbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFBQSwwREFBdUQ7QUFDdkQsNERBQXFFO0FBQ3JFLDhEQUEwRDtBQUMxRCx3REFHK0I7QUFLL0IsTUFBTSxNQUFNLEdBQUcsSUFBSSxlQUFNLENBQUM7SUFDeEIsV0FBVyxFQUFFLGdCQUFnQjtJQUM3QixRQUFRLEVBQUUsTUFBTTtDQUNqQixDQUFDLENBQUM7QUFFSCxNQUFNLE9BQU8sR0FBRyxJQUFJLGlCQUFPLENBQUM7SUFDMUIsU0FBUyxFQUFFLGFBQWE7SUFDeEIsV0FBVyxFQUFFLGdCQUFnQjtJQUM3QixpQkFBaUIsRUFBRTtRQUNqQixXQUFXLEVBQUUsT0FBTyxDQUFDLEdBQUcsQ0FBQyxXQUFXLElBQUksYUFBYTtLQUN0RDtDQUNGLENBQUMsQ0FBQztBQUVILE1BQU0sTUFBTSxHQUFHLElBQUksZ0NBQWMsQ0FBQztJQUNoQyxNQUFNLEVBQUUsT0FBTyxDQUFDLEdBQUcsQ0FBQyxNQUFNO0NBQzNCLENBQUMsQ0FBQztBQUNILE1BQU0sU0FBUyxHQUFHLHFDQUFzQixDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQztBQUV0RCxNQUFNLGNBQWMsR0FBRyxDQUFDLFVBQWtCLEVBQUUsSUFBUyxFQUFFLEVBQUUsQ0FBQyxDQUFDO0lBQ3pELFVBQVU7SUFDVixPQUFPLEVBQUU7UUFDUCw2QkFBNkIsRUFBRSxHQUFHO1FBQ2xDLGtDQUFrQyxFQUFFLElBQUk7S0FDekM7SUFDRCxJQUFJLEVBQUUsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUM7Q0FDM0IsQ0FBQyxDQUFDO0FBRUksTUFBTSxPQUFPLEdBQUcsS0FBSyxFQUFFLEtBQVUsRUFBRSxFQUFFO0lBQzFDLE1BQU0sQ0FBQyxVQUFVLENBQUMsS0FBSyxDQUFDLENBQUM7SUFDekIsTUFBTSxTQUFTLEdBQUcsS0FBSyxDQUFDLGNBQWMsRUFBRSxFQUFFLENBQUM7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LEdBQUcsRUFBRTtZQUN6QixPQUFPLEVBQUUsOENBQThDO1lBQ3ZELEtBQUssRUFBRSxPQUFPLENBQUMsR0FBRyxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsdUJBQXVCO1NBQ3hFLENBQUMsQ0FBQztJQUNMLENBQUM7WUFBUyxDQUFDO1FBQ1QsT0FBTyxDQUFDLG9CQUFvQixFQUFFLENBQUM7SUFDakMsQ0FBQztBQUNILENBQUMsQ0FBQztBQTNFVyxRQUFBLE9BQU8sV0EyRWxCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgTG9nZ2VyIH0gZnJvbSAnQGF3cy1sYW1iZGEtcG93ZXJ0b29scy9sb2dnZXInO1xuaW1wb3J0IHsgTWV0cmljcywgTWV0cmljVW5pdCB9IGZyb20gJ0Bhd3MtbGFtYmRhLXBvd2VydG9vbHMvbWV0cmljcyc7XG5pbXBvcnQgeyBEeW5hbW9EQkNsaWVudCB9IGZyb20gXCJAYXdzLXNkay9jbGllbnQtZHluYW1vZGJcIjtcbmltcG9ydCB7XG4gIER5bmFtb0RCRG9jdW1lbnRDbGllbnQsXG4gIEdldENvbW1hbmRcbn0gZnJvbSBcIkBhd3Mtc2RrL2xpYi1keW5hbW9kYlwiO1xuXG5pbXBvcnQge1Byb2R1Y3QsIFByb2R1Y3RXaXRoU3RvY2t9IGZyb20gXCIuLi8uLi90eXBlcy9Qcm9kdWN0c1wiO1xuaW1wb3J0IHtTdG9ja30gZnJvbSBcIi4uLy4uL3R5cGVzL1N0b2Nrc1wiO1xuXG5jb25zdCBsb2dnZXIgPSBuZXcgTG9nZ2VyKHtcbiAgc2VydmljZU5hbWU6ICdwcm9kdWN0U2VydmljZScsXG4gIGxvZ0xldmVsOiAnSU5GTydcbn0pO1xuXG5jb25zdCBtZXRyaWNzID0gbmV3IE1ldHJpY3Moe1xuICBuYW1lc3BhY2U6ICdQcm9kdWN0c0FwcCcsXG4gIHNlcnZpY2VOYW1lOiAncHJvZHVjdFNlcnZpY2UnLFxuICBkZWZhdWx0RGltZW5zaW9uczoge1xuICAgIGVudmlyb25tZW50OiBwcm9jZXNzLmVudi5FTlZJUk9OTUVOVCB8fCAnZGV2ZWxvcG1lbnQnXG4gIH1cbn0pO1xuXG5jb25zdCBjbGllbnQgPSBuZXcgRHluYW1vREJDbGllbnQoe1xuICByZWdpb246IHByb2Nlc3MuZW52LlJFR0lPTlxufSk7XG5jb25zdCBkb2NDbGllbnQgPSBEeW5hbW9EQkRvY3VtZW50Q2xpZW50LmZyb20oY2xpZW50KTtcblxuY29uc3QgY3JlYXRlUmVzcG9uc2UgPSAoc3RhdHVzQ29kZTogbnVtYmVyLCBib2R5OiBhbnkpID0+ICh7XG4gIHN0YXR1c0NvZGUsXG4gIGhlYWRlcnM6IHtcbiAgICAnQWNjZXNzLUNvbnRyb2wtQWxsb3ctT3JpZ2luJzogJyonLFxuICAgICdBY2Nlc3MtQ29udHJvbC1BbGxvdy1DcmVkZW50aWFscyc6IHRydWUsXG4gIH0sXG4gIGJvZHk6IEpTT04uc3RyaW5naWZ5KGJvZHkpXG59KTtcblxuZXhwb3J0IGNvbnN0IGhhbmRsZXIgPSBhc3luYyAoZXZlbnQ6IGFueSkgPT4ge1xuICBsb2dnZXIuYWRkQ29udGV4dChldmVudCk7XG4gIGNvbnN0IHByb2R1Y3RJZCA9IGV2ZW50LnBhdGhQYXJhbWV0ZXJzPy5pZDtcblxuICB0cnkge1xuICAgIGxvZ2dlci5pbmZvKCdHZXR0aW5nIHByb2R1Y3QgYnkgSUQnLCB7XG4gICAgICBvcGVyYXRpb246ICdnZXRQcm9kdWN0QnlJZCcsXG4gICAgICBwcm9kdWN0SWRcbiAgICB9KTtcbiAgICBtZXRyaWNzLmFkZE1ldHJpYygnZ2V0UHJvZHVjdEJ5SWRJbnZvY2F0aW9ucycsIE1ldHJpY1VuaXQuQ291bnQsIDEpO1xuXG4gICAgaWYgKCFwcm9kdWN0SWQpIHtcbiAgICAgIGxvZ2dlci5lcnJvcignTWlzc2luZyBwcm9kdWN0IElEJyk7XG4gICAgICBtZXRyaWNzLmFkZE1ldHJpYygnbWlzc2luZ1Byb2R1Y3RJZEVycm9ycycsIE1ldHJpY1VuaXQuQ291bnQsIDEpO1xuICAgICAgcmV0dXJuIGNyZWF0ZVJlc3BvbnNlKDQwMCwgeyBtZXNzYWdlOiAnTWlzc2luZyBwcm9kdWN0IElEJyB9KTtcbiAgICB9XG5cbiAgICAvLyBHZXQgcHJvZHVjdFxuICAgIGNvbnN0IHByb2R1Y3RQYXJhbXMgPSB7XG4gICAgICBUYWJsZU5hbWU6IHByb2Nlc3MuZW52LlBST0RVQ1RTX1RBQkxFLFxuICAgICAgS2V5OiB7IGlkOiBwcm9kdWN0SWQgfVxuICAgIH07XG5cbiAgICBjb25zdCBwcm9kdWN0Q29tbWFuZCA9IG5ldyBHZXRDb21tYW5kKHByb2R1Y3RQYXJhbXMpO1xuICAgIGNvbnN0IHByb2R1Y3RSZXNwb25zZSA9IGF3YWl0IGRvY0NsaWVudC5zZW5kKHByb2R1Y3RDb21tYW5kKTtcblxuICAgIGlmICghcHJvZHVjdFJlc3BvbnNlLkl0ZW0pIHtcbiAgICAgIGxvZ2dlci5pbmZvKCdQcm9kdWN0IG5vdCBmb3VuZCcsIHsgcHJvZHVjdElkIH0pO1xuICAgICAgbWV0cmljcy5hZGRNZXRyaWMoJ3Byb2R1Y3ROb3RGb3VuZCcsIE1ldHJpY1VuaXQuQ291bnQsIDEpO1xuICAgICAgcmV0dXJuIGNyZWF0ZVJlc3BvbnNlKDQwNCwge1xuICAgICAgICBtZXNzYWdlOiAnUHJvZHVjdCBub3QgZm91bmQnXG4gICAgICB9KTtcbiAgICB9XG5cbiAgICAvLyBHZXQgc3RvY2tcbiAgICBjb25zdCBzdG9ja1BhcmFtcyA9IHtcbiAgICAgIFRhYmxlTmFtZTogcHJvY2Vzcy5lbnYuU1RPQ0tTX1RBQkxFLFxuICAgICAgS2V5OiB7IHByb2R1Y3RfaWQ6IHByb2R1Y3RJZCB9XG4gICAgfTtcblxuICAgIGNvbnN0IHN0b2NrQ29tbWFuZCA9IG5ldyBHZXRDb21tYW5kKHN0b2NrUGFyYW1zKTtcbiAgICBjb25zdCBzdG9ja1Jlc3BvbnNlID0gYXdhaXQgZG9jQ2xpZW50LnNlbmQoc3RvY2tDb21tYW5kKTtcblxuICAgIGNvbnN0IHByb2R1Y3QgPSBwcm9kdWN0UmVzcG9uc2UuSXRlbSBhcyBQcm9kdWN0O1xuICAgIGNvbnN0IHN0b2NrID0gc3RvY2tSZXNwb25zZS5JdGVtIGFzIFN0b2NrO1xuXG4gICAgY29uc3QgcmVzcG9uc2U6IFByb2R1Y3RXaXRoU3RvY2sgPSB7XG4gICAgICAuLi5wcm9kdWN0LFxuICAgICAgY291bnQ6IHN0b2NrPy5jb3VudCB8fCAwXG4gICAgfTtcblxuICAgIGxvZ2dlci5pbmZvKCdTdWNjZXNzZnVsbHkgcmV0cmlldmVkIHByb2R1Y3QnLCB7XG4gICAgICBwcm9kdWN0SWQsXG4gICAgICBoYXNTdG9jazogISFzdG9ja1xuICAgIH0pO1xuICAgIG1ldHJpY3MuYWRkTWV0cmljKCdzdWNjZXNzZnVsUHJvZHVjdFJldHJpZXZhbCcsIE1ldHJpY1VuaXQuQ291bnQsIDEpO1xuXG4gICAgcmV0dXJuIGNyZWF0ZVJlc3BvbnNlKDIwMCwgcmVzcG9uc2UpO1xuXG4gIH0gY2F0Y2ggKGVycm9yOiBhbnkpIHtcbiAgICBsb2dnZXIuZXJyb3IoJ0Vycm9yIGdldHRpbmcgcHJvZHVjdCcsIHtcbiAgICAgIHByb2R1Y3RJZCxcbiAgICAgIGVycm9yOiBlcnJvci5tZXNzYWdlLFxuICAgICAgZXJyb3JOYW1lOiBlcnJvci5uYW1lLFxuICAgICAgc3RhY2tUcmFjZTogZXJyb3Iuc3RhY2tcbiAgICB9KTtcbiAgICBtZXRyaWNzLmFkZE1ldHJpYygncHJvZHVjdFJldHJpZXZhbEVycm9ycycsIE1ldHJpY1VuaXQuQ291bnQsIDEpO1xuXG4gICAgcmV0dXJuIGNyZWF0ZVJlc3BvbnNlKDUwMCwge1xuICAgICAgbWVzc2FnZTogJ0ludGVybmFsIHNlcnZlciBlcnJvciB3aGlsZSBmZXRjaGluZyBwcm9kdWN0JyxcbiAgICAgIGVycm9yOiBwcm9jZXNzLmVudi5JU19PRkZMSU5FID8gZXJyb3IubWVzc2FnZSA6ICdJbnRlcm5hbCBzZXJ2ZXIgZXJyb3InXG4gICAgfSk7XG4gIH0gZmluYWxseSB7XG4gICAgbWV0cmljcy5wdWJsaXNoU3RvcmVkTWV0cmljcygpO1xuICB9XG59O1xuIl19