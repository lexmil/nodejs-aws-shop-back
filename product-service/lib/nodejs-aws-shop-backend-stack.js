"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.NodejsAwsShopBackendStack = void 0;
const cdk = require("aws-cdk-lib");
const dotenv = require("dotenv");
const lambda = require("aws-cdk-lib/aws-lambda");
const nodejs = require("aws-cdk-lib/aws-lambda-nodejs");
const apigateway = require("aws-cdk-lib/aws-apigateway");
const dynamodb = require("aws-cdk-lib/aws-dynamodb");
const aws_sns_1 = require("aws-cdk-lib/aws-sns");
const aws_sqs_1 = require("aws-cdk-lib/aws-sqs");
const aws_sns_subscriptions_1 = require("aws-cdk-lib/aws-sns-subscriptions");
const aws_lambda_event_sources_1 = require("aws-cdk-lib/aws-lambda-event-sources");
const path = require("path");
dotenv.config({ path: "../.env" });
class NodejsAwsShopBackendStack extends cdk.Stack {
    constructor(scope, id, props) {
        super(scope, id, props);
        const IMPORT_SERVICE_QUEUE_NAME = process.env.IMPORT_SERVICE_QUEUE_NAME;
        if (!IMPORT_SERVICE_QUEUE_NAME) {
            throw new Error("IMPORT_SERVICE_QUEUE_NAME environment variable is not set");
        }
        const productsTable = new dynamodb.Table(this, "ProductsTable", {
            tableName: "products",
            partitionKey: { name: "id", type: dynamodb.AttributeType.STRING },
            removalPolicy: cdk.RemovalPolicy.DESTROY, // Changed to DESTROY for easy cleanup
            billingMode: dynamodb.BillingMode.PROVISIONED,
            readCapacity: 1, // Minimum possible value
            writeCapacity: 1, // Minimum possible value
        });
        const stocksTable = new dynamodb.Table(this, "StocksTable", {
            tableName: "stocks",
            partitionKey: { name: "product_id", type: dynamodb.AttributeType.STRING },
            removalPolicy: cdk.RemovalPolicy.DESTROY,
            billingMode: dynamodb.BillingMode.PROVISIONED,
            readCapacity: 1,
            writeCapacity: 1,
        });
        const catalogItemsQueue = new aws_sqs_1.Queue(this, "CatalogItemsQueue", {
            queueName: IMPORT_SERVICE_QUEUE_NAME,
        });
        const createProductTopic = new aws_sns_1.Topic(this, "CreateProductTopic", {
            topicName: "createProductTopic",
        });
        // Add email subscription
        createProductTopic.addSubscription(new aws_sns_subscriptions_1.EmailSubscription("a.milashchenkov@softteco.com", {
            filterPolicy: {
                price: aws_sns_1.SubscriptionFilter.numericFilter({
                    greaterThanOrEqualTo: 100,
                }),
            },
        }));
        createProductTopic.addSubscription(new aws_sns_subscriptions_1.EmailSubscription("encode.cpp@gmail.com", {
            filterPolicy: {
                price: aws_sns_1.SubscriptionFilter.numericFilter({
                    lessThanOrEqualTo: 100,
                }),
            },
        }));
        const catalogBatchProcess = new nodejs.NodejsFunction(this, "CatalogBatchProcess", {
            runtime: lambda.Runtime.NODEJS_20_X,
            handler: "index.handler",
            entry: path.join(__dirname, "../lambda/catalogBatchProcess/index.ts"),
            bundling: {
                externalModules: [],
                minify: true,
                sourceMap: false,
            },
            environment: {
                SNS_TOPIC_ARN: createProductTopic.topicArn,
                PRODUCTS_TABLE: productsTable.tableName,
                STOCKS_TABLE: stocksTable.tableName,
            },
        });
        createProductTopic.grantPublish(catalogBatchProcess);
        catalogBatchProcess.addEventSource(new aws_lambda_event_sources_1.SqsEventSource(catalogItemsQueue, {
            batchSize: 5,
        }));
        const api = new apigateway.RestApi(this, "NodejsAwsShopApi", {
            restApiName: "Shop Service",
            description: "This is the Shop API",
            defaultCorsPreflightOptions: {
                allowOrigins: apigateway.Cors.ALL_ORIGINS,
                allowMethods: apigateway.Cors.ALL_METHODS,
                allowHeaders: apigateway.Cors.DEFAULT_HEADERS,
            },
        });
        // Lambda functions
        const getProductsListFunction = new nodejs.NodejsFunction(this, "getProductsList", {
            bundling: {
                externalModules: [],
                minify: true,
                sourceMap: false,
            },
            runtime: lambda.Runtime.NODEJS_20_X,
            handler: "index.handler",
            entry: path.join(__dirname, "../lambda/getProductsList/index.ts"),
            environment: {
                PRODUCTS_TABLE: productsTable.tableName,
                STOCKS_TABLE: stocksTable.tableName,
                REGION: cdk.Stack.of(this).region,
                POWERTOOLS_SERVICE_NAME: "productService",
                POWERTOOLS_METRICS_NAMESPACE: "ProductsApp",
                LOG_LEVEL: "INFO",
            },
        });
        const getProductsByIdFunction = new nodejs.NodejsFunction(this, "getProductsById", {
            bundling: {
                externalModules: [],
                minify: true,
                sourceMap: false,
            },
            runtime: lambda.Runtime.NODEJS_20_X,
            handler: "index.handler",
            entry: path.join(__dirname, "../lambda/getProductsById/index.ts"),
            environment: {
                PRODUCTS_TABLE: productsTable.tableName,
                STOCKS_TABLE: stocksTable.tableName,
                REGION: cdk.Stack.of(this).region,
            },
        });
        const createProductFunction = new nodejs.NodejsFunction(this, "createProduct", {
            bundling: {
                externalModules: [],
                minify: true,
                sourceMap: false,
            },
            runtime: lambda.Runtime.NODEJS_20_X,
            handler: "index.handler",
            entry: path.join(__dirname, "../lambda/createProduct/index.ts"),
            environment: {
                PRODUCTS_TABLE: productsTable.tableName,
                STOCKS_TABLE: stocksTable.tableName,
                REGION: cdk.Stack.of(this).region,
            },
        });
        // Grant permissions to Lambda
        productsTable.grantReadData(getProductsListFunction);
        productsTable.grantReadData(getProductsByIdFunction);
        productsTable.grantWriteData(createProductFunction);
        productsTable.grantWriteData(catalogBatchProcess);
        stocksTable.grantReadData(getProductsListFunction);
        stocksTable.grantReadData(getProductsByIdFunction);
        stocksTable.grantWriteData(createProductFunction);
        stocksTable.grantWriteData(catalogBatchProcess);
        createProductTopic.grantPublish(catalogBatchProcess);
        catalogItemsQueue.grantConsumeMessages(catalogBatchProcess);
        const products = api.root.addResource("products");
        products.addMethod("GET", new apigateway.LambdaIntegration(getProductsListFunction, {
            proxy: true,
            requestTemplates: {
                "application/json": '{ "statusCode": "200" }',
            },
        }));
        products.addMethod("POST", new apigateway.LambdaIntegration(createProductFunction, {
            proxy: true,
        }));
        const product = products.addResource("{id}");
        product.addMethod("GET", new apigateway.LambdaIntegration(new nodejs.NodejsFunction(this, "getProductsByIdGet", {
            runtime: lambda.Runtime.NODEJS_20_X,
            handler: "index.handler",
            entry: path.join(__dirname, "../lambda/getProductsById/index.ts"),
        }), {
            proxy: true,
        }));
        // Add API Gateway response (optional)
        api.addGatewayResponse("DefaultError", {
            type: apigateway.ResponseType.DEFAULT_4XX,
            responseHeaders: {
                "Access-Control-Allow-Origin": "'*'",
            },
        });
        // Output the API URL
        new cdk.CfnOutput(this, "ApiUrl", {
            value: api.url,
            description: "API Gateway URL",
        });
    }
}
exports.NodejsAwsShopBackendStack = NodejsAwsShopBackendStack;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibm9kZWpzLWF3cy1zaG9wLWJhY2tlbmQtc3RhY2suanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJub2RlanMtYXdzLXNob3AtYmFja2VuZC1zdGFjay50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFBQSxtQ0FBbUM7QUFDbkMsaUNBQWlDO0FBQ2pDLGlEQUFpRDtBQUNqRCx3REFBd0Q7QUFDeEQseURBQXlEO0FBQ3pELHFEQUFxRDtBQUNyRCxpREFBZ0U7QUFDaEUsaURBQTRDO0FBQzVDLDZFQUFzRTtBQUN0RSxtRkFBc0U7QUFFdEUsNkJBQTZCO0FBRTdCLE1BQU0sQ0FBQyxNQUFNLENBQUMsRUFBRSxJQUFJLEVBQUUsU0FBUyxFQUFFLENBQUMsQ0FBQztBQUluQyxNQUFhLHlCQUEwQixTQUFRLEdBQUcsQ0FBQyxLQUFLO0lBQ3RELFlBQVksS0FBZ0IsRUFBRSxFQUFVLEVBQUUsS0FBc0I7UUFDOUQsS0FBSyxDQUFDLEtBQUssRUFBRSxFQUFFLEVBQUUsS0FBSyxDQUFDLENBQUM7UUFFeEIsTUFBTSx5QkFBeUIsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLHlCQUF5QixDQUFDO1FBRXhFLElBQUksQ0FBQyx5QkFBeUIsRUFBRSxDQUFDO1lBQy9CLE1BQU0sSUFBSSxLQUFLLENBQ2IsMkRBQTJELENBQzVELENBQUM7UUFDSixDQUFDO1FBRUQsTUFBTSxhQUFhLEdBQUcsSUFBSSxRQUFRLENBQUMsS0FBSyxDQUFDLElBQUksRUFBRSxlQUFlLEVBQUU7WUFDOUQsU0FBUyxFQUFFLFVBQVU7WUFDckIsWUFBWSxFQUFFLEVBQUUsSUFBSSxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsUUFBUSxDQUFDLGFBQWEsQ0FBQyxNQUFNLEVBQUU7WUFDakUsYUFBYSxFQUFFLEdBQUcsQ0FBQyxhQUFhLENBQUMsT0FBTyxFQUFFLHNDQUFzQztZQUNoRixXQUFXLEVBQUUsUUFBUSxDQUFDLFdBQVcsQ0FBQyxXQUFXO1lBQzdDLFlBQVksRUFBRSxDQUFDLEVB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RUFBRTtZQUNoQyxLQUFLLEVBQUUsR0FBRyxDQUFDLEdBQUc7WUFDZCxXQUFXLEVBQUUsaUJBQWlCO1NBQy9CLENBQUMsQ0FBQztJQUNMLENBQUM7Q0FDRjtBQS9ORCw4REErTkMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBjZGsgZnJvbSBcImF3cy1jZGstbGliXCI7XG5pbXBvcnQgKiBhcyBkb3RlbnYgZnJvbSBcImRvdGVudlwiO1xuaW1wb3J0ICogYXMgbGFtYmRhIGZyb20gXCJhd3MtY2RrLWxpYi9hd3MtbGFtYmRhXCI7XG5pbXBvcnQgKiBhcyBub2RlanMgZnJvbSBcImF3cy1jZGstbGliL2F3cy1sYW1iZGEtbm9kZWpzXCI7XG5pbXBvcnQgKiBhcyBhcGlnYXRld2F5IGZyb20gXCJhd3MtY2RrLWxpYi9hd3MtYXBpZ2F0ZXdheVwiO1xuaW1wb3J0ICogYXMgZHluYW1vZGIgZnJvbSBcImF3cy1jZGstbGliL2F3cy1keW5hbW9kYlwiO1xuaW1wb3J0IHsgVG9waWMsIFN1YnNjcmlwdGlvbkZpbHRlciB9IGZyb20gXCJhd3MtY2RrLWxpYi9hd3Mtc25zXCI7XG5pbXBvcnQgeyBRdWV1ZSB9IGZyb20gXCJhd3MtY2RrLWxpYi9hd3Mtc3FzXCI7XG5pbXBvcnQgeyBFbWFpbFN1YnNjcmlwdGlvbiB9IGZyb20gXCJhd3MtY2RrLWxpYi9hd3Mtc25zLXN1YnNjcmlwdGlvbnNcIjtcbmltcG9ydCB7IFNxc0V2ZW50U291cmNlIH0gZnJvbSBcImF3cy1jZGstbGliL2F3cy1sYW1iZGEtZXZlbnQtc291cmNlc1wiO1xuXG5pbXBvcnQgKiBhcyBwYXRoIGZyb20gXCJwYXRoXCI7XG5cbmRvdGVudi5jb25maWcoeyBwYXRoOiBcIi4uLy5lbnZcIiB9KTtcblxuaW1wb3J0IHsgQ29uc3RydWN0IH0gZnJvbSBcImNvbnN0cnVjdHNcIjtcblxuZXhwb3J0IGNsYXNzIE5vZGVqc0F3c1Nob3BCYWNrZW5kU3RhY2sgZXh0ZW5kcyBjZGsuU3RhY2sge1xuICBjb25zdHJ1Y3RvcihzY29wZTogQ29uc3RydWN0LCBpZDogc3RyaW5nLCBwcm9wcz86IGNkay5TdGFja1Byb3BzKSB7XG4gICAgc3VwZXIoc2NvcGUsIGlkLCBwcm9wcyk7XG5cbiAgICBjb25zdCBJTVBPUlRfU0VSVklDRV9RVUVVRV9OQU1FID0gcHJvY2Vzcy5lbnYuSU1QT1JUX1NFUlZJQ0VfUVVFVUVfTkFNRTtcblxuICAgIGlmICghSU1QT1JUX1NFUlZJQ0VfUVVFVUVfTkFNRSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICBcIklNUE9SVF9TRVJWSUNFX1FVRVVFX05BTUUgZW52aXJvbm1lbnQgdmFyaWFibGUgaXMgbm90IHNldFwiLFxuICAgICAgKTtcbiAgICB9XG5cbiAgICBjb25zdCBwcm9kdWN0c1RhYmxlID0gbmV3IGR5bmFtb2RiLlRhYmxlKHRoaXMsIFwiUHJvZHVjdHNUYWJsZVwiLCB7XG4gICAgICB0YWJsZU5hbWU6IFwicHJvZHVjdHNcIixcbiAgICAgIHBhcnRpdGlvbktleTogeyBuYW1lOiBcImlkXCIsIHR5cGU6IGR5bmFtb2RiLkF0dHJpYnV0ZVR5cGUuU1RSSU5HIH0sXG4gICAgICByZW1vdmFsUG9saWN5OiBjZGsuUmVtb3ZhbFBvbGljeS5ERVNUUk9ZLCAvLyBDaGFuZ2VkIHRvIERFU1RST1kgZm9yIGVhc3kgY2xlYW51cFxuICAgICAgYmlsbGluZ01vZGU6IGR5bmFtb2RiLkJpbGxpbmdNb2RlLlBST1ZJU0lPTkVELFxuICAgICAgcmVhZENhcGFjaXR5OiAxLCAvLyBNaW5pbXVtIHBvc3NpYmxlIHZhbHVlXG4gICAgICB3cml0ZUNhcGFjaXR5OiAxLCAvLyBNaW5pbXVtIHBvc3NpYmxlIHZhbHVlXG4gICAgfSk7XG5cbiAgICBjb25zdCBzdG9ja3NUYWJsZSA9IG5ldyBkeW5hbW9kYi5UYWJsZSh0aGlzLCBcIlN0b2Nrc1RhYmxlXCIsIHtcbiAgICAgIHRhYmxlTmFtZTogXCJzdG9ja3NcIixcbiAgICAgIHBhcnRpdGlvbktleTogeyBuYW1lOiBcInByb2R1Y3RfaWRcIiwgdHlwZTogZHluYW1vZGIuQXR0cmlidXRlVHlwZS5TVFJJTkcgfSxcbiAgICAgIHJlbW92YWxQb2xpY3k6IGNkay5SZW1vdmFsUG9saWN5LkRFU1RST1ksXG4gICAgICBiaWxsaW5nTW9kZTogZHluYW1vZGIuQmlsbGluZ01vZGUuUFJPVklTSU9ORUQsXG4gICAgICByZWFkQ2FwYWNpdHk6IDEsXG4gICAgICB3cml0ZUNhcGFjaXR5OiAxLFxuICAgIH0pO1xuXG4gICAgY29uc3QgY2F0YWxvZ0l0ZW1zUXVldWUgPSBuZXcgUXVldWUodGhpcywgXCJDYXRhbG9nSXRlbXNRdWV1ZVwiLCB7XG4gICAgICBxdWV1ZU5hbWU6IElNUE9SVF9TRVJWSUNFX1FVRVVFX05BTUUsXG4gICAgfSk7XG5cbiAgICBjb25zdCBjcmVhdGVQcm9kdWN0VG9waWMgPSBuZXcgVG9waWModGhpcywgXCJDcmVhdGVQcm9kdWN0VG9waWNcIiwge1xuICAgICAgdG9waWNOYW1lOiBcImNyZWF0ZVByb2R1Y3RUb3BpY1wiLFxuICAgIH0pO1xuXG4gICAgLy8gQWRkIGVtYWlsIHN1YnNjcmlwdGlvblxuICAgIGNyZWF0ZVByb2R1Y3RUb3BpYy5hZGRTdWJzY3JpcHRpb24oXG4gICAgICBuZXcgRW1haWxTdWJzY3JpcHRpb24oXCJhLm1pbGFzaGNoZW5rb3ZAc29mdHRlY28uY29tXCIsIHtcbiAgICAgICAgZmlsdGVyUG9saWN5OiB7XG4gICAgICAgICAgcHJpY2U6IFN1YnNjcmlwdGlvbkZpbHRlci5udW1lcmljRmlsdGVyKHtcbiAgICAgICAgICAgIGdyZWF0ZXJUaGFuT3JFcXVhbFRvOiAxMDAsXG4gICAgICAgICAgfSksXG4gICAgICAgIH0sXG4gICAgICB9KSxcbiAgICApO1xuICAgIGNyZWF0ZVByb2R1Y3RUb3BpYy5hZGRTdWJzY3JpcHRpb24oXG4gICAgICBuZXcgRW1haWxTdWJzY3JpcHRpb24oXCJlbmNvZGUuY3BwQGdtYWlsLmNvbVwiLCB7XG4gICAgICAgIGZpbHRlclBvbGljeToge1xuICAgICAgICAgIHByaWNlOiBTdWJzY3JpcHRpb25GaWx0ZXIubnVtZXJpY0ZpbHRlcih7XG4gICAgICAgICAgICBsZXNzVGhhbk9yRXF1YWxUbzogMTAwLFxuICAgICAgICAgIH0pLFxuICAgICAgICB9LFxuICAgICAgfSksXG4gICAgKTtcblxuICAgIGNvbnN0IGNhdGFsb2dCYXRjaFByb2Nlc3MgPSBuZXcgbm9kZWpzLk5vZGVqc0Z1bmN0aW9uKFxuICAgICAgdGhpcyxcbiAgICAgIFwiQ2F0YWxvZ0JhdGNoUHJvY2Vzc1wiLFxuICAgICAge1xuICAgICAgICBydW50aW1lOiBsYW1iZGEuUnVudGltZS5OT0RFSlNfMjBfWCxcbiAgICAgICAgaGFuZGxlcjogXCJpbmRleC5oYW5kbGVyXCIsXG4gICAgICAgIGVudHJ5OiBwYXRoLmpvaW4oX19kaXJuYW1lLCBcIi4uL2xhbWJkYS9jYXRhbG9nQmF0Y2hQcm9jZXNzL2luZGV4LnRzXCIpLFxuICAgICAgICBidW5kbGluZzoge1xuICAgICAgICAgIGV4dGVybmFsTW9kdWxlczogW10sXG4gICAgICAgICAgbWluaWZ5OiB0cnVlLFxuICAgICAgICAgIHNvdXJjZU1hcDogZmFsc2UsXG4gICAgICAgIH0sXG4gICAgICAgIGVudmlyb25tZW50OiB7XG4gICAgICAgICAgU05TX1RPUElDX0FSTjogY3JlYXRlUHJvZHVjdFRvcGljLnRvcGljQXJuLFxuICAgICAgICAgIFBST0RVQ1RTX1RBQkxFOiBwcm9kdWN0c1RhYmxlLnRhYmxlTmFtZSxcbiAgICAgICAgICBTVE9DS1NfVEFCTEU6IHN0b2Nrc1RhYmxlLnRhYmxlTmFtZSxcbiAgICAgICAgfSxcbiAgICAgIH0sXG4gICAgKTtcblxuICAgIGNyZWF0ZVByb2R1Y3RUb3BpYy5ncmFudFB1Ymxpc2goY2F0YWxvZ0JhdGNoUHJvY2Vzcyk7XG5cbiAgICBjYXRhbG9nQmF0Y2hQcm9jZXNzLmFkZEV2ZW50U291cmNlKFxuICAgICAgbmV3IFNxc0V2ZW50U291cmNlKGNhdGFsb2dJdGVtc1F1ZXVlLCB7XG4gICAgICAgIGJhdGNoU2l6ZTogNSxcbiAgICAgIH0pLFxuICAgICk7XG5cbiAgICBjb25zdCBhcGkgPSBuZXcgYXBpZ2F0ZXdheS5SZXN0QXBpKHRoaXMsIFwiTm9kZWpzQXdzU2hvcEFwaVwiLCB7XG4gICAgICByZXN0QXBpTmFtZTogXCJTaG9wIFNlcnZpY2VcIixcbiAgICAgIGRlc2NyaXB0aW9uOiBcIlRoaXMgaXMgdGhlIFNob3AgQVBJXCIsXG4gICAgICBkZWZhdWx0Q29yc1ByZWZsaWdodE9wdGlvbnM6IHtcbiAgICAgICAgYWxsb3dPcmlnaW5zOiBhcGlnYXRld2F5LkNvcnMuQUxMX09SSUdJTlMsXG4gICAgICAgIGFsbG93TWV0aG9kczogYXBpZ2F0ZXdheS5Db3JzLkFMTF9NRVRIT0RTLFxuICAgICAgICBhbGxvd0hlYWRlcnM6IGFwaWdhdGV3YXkuQ29ycy5ERUZBVUxUX0hFQURFUlMsXG4gICAgICB9LFxuICAgIH0pO1xuXG4gICAgLy8gTGFtYmRhIGZ1bmN0aW9uc1xuICAgIGNvbnN0IGdldFByb2R1Y3RzTGlzdEZ1bmN0aW9uID0gbmV3IG5vZGVqcy5Ob2RlanNGdW5jdGlvbihcbiAgICAgIHRoaXMsXG4gICAgICBcImdldFByb2R1Y3RzTGlzdFwiLFxuICAgICAge1xuICAgICAgICBidW5kbGluZzoge1xuICAgICAgICAgIGV4dGVybmFsTW9kdWxlczogW10sXG4gICAgICAgICAgbWluaWZ5OiB0cnVlLFxuICAgICAgICAgIHNvdXJjZU1hcDogZmFsc2UsXG4gICAgICAgIH0sXG4gICAgICAgIHJ1bnRpbWU6IGxhbWJkYS5SdW50aW1lLk5PREVKU18yMF9YLFxuICAgICAgICBoYW5kbGVyOiBcImluZGV4LmhhbmRsZXJcIixcbiAgICAgICAgZW50cnk6IHBhdGguam9pbihfX2Rpcm5hbWUsIFwiLi4vbGFtYmRhL2dldFByb2R1Y3RzTGlzdC9pbmRleC50c1wiKSxcbiAgICAgICAgZW52aXJvbm1lbnQ6IHtcbiAgICAgICAgICBQUk9EVUNUU19UQUJMRTogcHJvZHVjdHNUYWJsZS50YWJsZU5hbWUsXG4gICAgICAgICAgU1RPQ0tTX1RBQkxFOiBzdG9ja3NUYWJsZS50YWJsZU5hbWUsXG4gICAgICAgICAgUkVHSU9OOiBjZGsuU3RhY2sub2YodGhpcykucmVnaW9uLFxuICAgICAgICAgIFBPV0VSVE9PTFNfU0VSVklDRV9OQU1FOiBcInByb2R1Y3RTZXJ2aWNlXCIsXG4gICAgICAgICAgUE9XRVJUT09MU19NRVRSSUNTX05BTUVTUEFDRTogXCJQcm9kdWN0c0FwcFwiLFxuICAgICAgICAgIExPR19MRVZFTDogXCJJTkZPXCIsXG4gICAgICAgIH0sXG4gICAgICB9LFxuICAgICk7XG5cbiAgICBjb25zdCBnZXRQcm9kdWN0c0J5SWRGdW5jdGlvbiA9IG5ldyBub2RlanMuTm9kZWpzRnVuY3Rpb24oXG4gICAgICB0aGlzLFxuICAgICAgXCJnZXRQcm9kdWN0c0J5SWRcIixcbiAgICAgIHtcbiAgICAgICAgYnVuZGxpbmc6IHtcbiAgICAgICAgICBleHRlcm5hbE1vZHVsZXM6IFtdLFxuICAgICAgICAgIG1pbmlmeTogdHJ1ZSxcbiAgICAgICAgICBzb3VyY2VNYXA6IGZhbHNlLFxuICAgICAgICB9LFxuICAgICAgICBydW50aW1lOiBsYW1iZGEuUnVudGltZS5OT0RFSlNfMjBfWCxcbiAgICAgICAgaGFuZGxlcjogXCJpbmRleC5oYW5kbGVyXCIsXG4gICAgICAgIGVudHJ5OiBwYXRoLmpvaW4oX19kaXJuYW1lLCBcIi4uL2xhbWJkYS9nZXRQcm9kdWN0c0J5SWQvaW5kZXgudHNcIiksXG4gICAgICAgIGVudmlyb25tZW50OiB7XG4gICAgICAgICAgUFJPRFVDVFNfVEFCTEU6IHByb2R1Y3RzVGFibGUudGFibGVOYW1lLFxuICAgICAgICAgIFNUT0NLU19UQUJMRTogc3RvY2tzVGFibGUudGFibGVOYW1lLFxuICAgICAgICAgIFJFR0lPTjogY2RrLlN0YWNrLm9mKHRoaXMpLnJlZ2lvbixcbiAgICAgICAgfSxcbiAgICAgIH0sXG4gICAgKTtcblxuICAgIGNvbnN0IGNyZWF0ZVByb2R1Y3RGdW5jdGlvbiA9IG5ldyBub2RlanMuTm9kZWpzRnVuY3Rpb24oXG4gICAgICB0aGlzLFxuICAgICAgXCJjcmVhdGVQcm9kdWN0XCIsXG4gICAgICB7XG4gICAgICAgIGJ1bmRsaW5nOiB7XG4gICAgICAgICAgZXh0ZXJuYWxNb2R1bGVzOiBbXSxcbiAgICAgICAgICBtaW5pZnk6IHRydWUsXG4gICAgICAgICAgc291cmNlTWFwOiBmYWxzZSxcbiAgICAgICAgfSxcbiAgICAgICAgcnVudGltZTogbGFtYmRhLlJ1bnRpbWUuTk9ERUpTXzIwX1gsXG4gICAgICAgIGhhbmRsZXI6IFwiaW5kZXguaGFuZGxlclwiLFxuICAgICAgICBlbnRyeTogcGF0aC5qb2luKF9fZGlybmFtZSwgXCIuLi9sYW1iZGEvY3JlYXRlUHJvZHVjdC9pbmRleC50c1wiKSxcbiAgICAgICAgZW52aXJvbm1lbnQ6IHtcbiAgICAgICAgICBQUk9EVUNUU19UQUJMRTogcHJvZHVjdHNUYWJsZS50YWJsZU5hbWUsXG4gICAgICAgICAgU1RPQ0tTX1RBQkxFOiBzdG9ja3NUYWJsZS50YWJsZU5hbWUsXG4gICAgICAgICAgUkVHSU9OOiBjZGsuU3RhY2sub2YodGhpcykucmVnaW9uLFxuICAgICAgICB9LFxuICAgICAgfSxcbiAgICApO1xuXG4gICAgLy8gR3JhbnQgcGVybWlzc2lvbnMgdG8gTGFtYmRhXG4gICAgcHJvZHVjdHNUYWJsZS5ncmFudFJlYWREYXRhKGdldFByb2R1Y3RzTGlzdEZ1bmN0aW9uKTtcbiAgICBwcm9kdWN0c1RhYmxlLmdyYW50UmVhZERhdGEoZ2V0UHJvZHVjdHNCeUlkRnVuY3Rpb24pO1xuICAgIHByb2R1Y3RzVGFibGUuZ3JhbnRXcml0ZURhdGEoY3JlYXRlUHJvZHVjdEZ1bmN0aW9uKTtcbiAgICBwcm9kdWN0c1RhYmxlLmdyYW50V3JpdGVEYXRhKGNhdGFsb2dCYXRjaFByb2Nlc3MpO1xuXG4gICAgc3RvY2tzVGFibGUuZ3JhbnRSZWFkRGF0YShnZXRQcm9kdWN0c0xpc3RGdW5jdGlvbik7XG4gICAgc3RvY2tzVGFibGUuZ3JhbnRSZWFkRGF0YShnZXRQcm9kdWN0c0J5SWRGdW5jdGlvbik7XG4gICAgc3RvY2tzVGFibGUuZ3JhbnRXcml0ZURhdGEoY3JlYXRlUHJvZHVjdEZ1bmN0aW9uKTtcbiAgICBzdG9ja3NUYWJsZS5ncmFudFdyaXRlRGF0YShjYXRhbG9nQmF0Y2hQcm9jZXNzKTtcblxuICAgIGNyZWF0ZVByb2R1Y3RUb3BpYy5ncmFudFB1Ymxpc2goY2F0YWxvZ0JhdGNoUHJvY2Vzcyk7XG4gICAgY2F0YWxvZ0l0ZW1zUXVldWUuZ3JhbnRDb25zdW1lTWVzc2FnZXMoY2F0YWxvZ0JhdGNoUHJvY2Vzcyk7XG5cbiAgICBjb25zdCBwcm9kdWN0cyA9IGFwaS5yb290LmFkZFJlc291cmNlKFwicHJvZHVjdHNcIik7XG5cbiAgICBwcm9kdWN0cy5hZGRNZXRob2QoXG4gICAgICBcIkdFVFwiLFxuICAgICAgbmV3IGFwaWdhdGV3YXkuTGFtYmRhSW50ZWdyYXRpb24oZ2V0UHJvZHVjdHNMaXN0RnVuY3Rpb24sIHtcbiAgICAgICAgcHJveHk6IHRydWUsXG4gICAgICAgIHJlcXVlc3RUZW1wbGF0ZXM6IHtcbiAgICAgICAgICBcImFwcGxpY2F0aW9uL2pzb25cIjogJ3sgXCJzdGF0dXNDb2RlXCI6IFwiMjAwXCIgfScsXG4gICAgICAgIH0sXG4gICAgICB9KSxcbiAgICApO1xuXG4gICAgcHJvZHVjdHMuYWRkTWV0aG9kKFxuICAgICAgXCJQT1NUXCIsXG4gICAgICBuZXcgYXBpZ2F0ZXdheS5MYW1iZGFJbnRlZ3JhdGlvbihjcmVhdGVQcm9kdWN0RnVuY3Rpb24sIHtcbiAgICAgICAgcHJveHk6IHRydWUsXG4gICAgICB9KSxcbiAgICApO1xuXG4gICAgY29uc3QgcHJvZHVjdCA9IHByb2R1Y3RzLmFkZFJlc291cmNlKFwie2lkfVwiKTtcblxuICAgIHByb2R1Y3QuYWRkTWV0aG9kKFxuICAgICAgXCJHRVRcIixcbiAgICAgIG5ldyBhcGlnYXRld2F5LkxhbWJkYUludGVncmF0aW9uKFxuICAgICAgICBuZXcgbm9kZWpzLk5vZGVqc0Z1bmN0aW9uKHRoaXMsIFwiZ2V0UHJvZHVjdHNCeUlkR2V0XCIsIHtcbiAgICAgICAgICBydW50aW1lOiBsYW1iZGEuUnVudGltZS5OT0RFSlNfMjBfWCxcbiAgICAgICAgICBoYW5kbGVyOiBcImluZGV4LmhhbmRsZXJcIixcbiAgICAgICAgICBlbnRyeTogcGF0aC5qb2luKF9fZGlybmFtZSwgXCIuLi9sYW1iZGEvZ2V0UHJvZHVjdHNCeUlkL2luZGV4LnRzXCIpLFxuICAgICAgICB9KSxcbiAgICAgICAge1xuICAgICAgICAgIHByb3h5OiB0cnVlLFxuICAgICAgICB9LFxuICAgICAgKSxcbiAgICApO1xuXG4gICAgLy8gQWRkIEFQSSBHYXRld2F5IHJlc3BvbnNlIChvcHRpb25hbClcbiAgICBhcGkuYWRkR2F0ZXdheVJlc3BvbnNlKFwiRGVmYXVsdEVycm9yXCIsIHtcbiAgICAgIHR5cGU6IGFwaWdhdGV3YXkuUmVzcG9uc2VUeXBlLkRFRkFVTFRfNFhYLFxuICAgICAgcmVzcG9uc2VIZWFkZXJzOiB7XG4gICAgICAgIFwiQWNjZXNzLUNvbnRyb2wtQWxsb3ctT3JpZ2luXCI6IFwiJyonXCIsXG4gICAgICB9LFxuICAgIH0pO1xuXG4gICAgLy8gT3V0cHV0IHRoZSBBUEkgVVJMXG4gICAgbmV3IGNkay5DZm5PdXRwdXQodGhpcywgXCJBcGlVcmxcIiwge1xuICAgICAgdmFsdWU6IGFwaS51cmwsXG4gICAgICBkZXNjcmlwdGlvbjogXCJBUEkgR2F0ZXdheSBVUkxcIixcbiAgICB9KTtcbiAgfVxufVxuIl19