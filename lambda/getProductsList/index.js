"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.handler = void 0;
const logger_1 = require("@aws-lambda-powertools/logger");
const metrics_1 = require("@aws-lambda-powertools/metrics");
const client_dynamodb_1 = require("@aws-sdk/client-dynamodb");
const lib_dynamodb_1 = require("@aws-sdk/lib-dynamodb");
const logger = new logger_1.Logger({
    serviceName: 'productService',
    logLevel: 'INFO'
});
const metrics = new metrics_1.Metrics({
    namespace: 'ProductsApp',
    serviceName: 'productService',
    defaultDimensions: {
        environment: process.env.ENVIRONMENT || 'development'
    }
});
const client = new client_dynamodb_1.DynamoDBClient({
    region: process.env.REGION
});
const docClient = lib_dynamodb_1.DynamoDBDocumentClient.from(client);
const createResponse = (statusCode, body) => ({
    statusCode,
    headers: {
        'Access-Control-Allow-Origin': '*',
        'Access-Control-Allow-Credentials': true,
    },
    body: JSON.stringify(body)
});
const handler = async (event) => {
    logger.addContext(event);
    try {
        logger.info('Getting products list', {
            operation: 'getProductsList'
        });
        metrics.addMetric('getProductsListInvocations', metrics_1.MetricUnit.Count, 1);
        // Get all products
        const productsParams = {
            TableName: process.env.PRODUCTS_TABLE,
        };
        const productsCommand = new lib_dynamodb_1.ScanCommand(productsParams);
        const productsResponse = await docClient.send(productsCommand);
        if (!productsResponse.Items || productsResponse.Items.length === 0) {
            logger.info('No products found');
            metrics.addMetric('emptyProductsList', metrics_1.MetricUnit.Count, 1);
            return createResponse(200, []);
        }
        // Get all stocks
        const stocksParams = {
            TableName: process.env.STOCKS_TABLE,
        };
        const stocksCommand = new lib_dynamodb_1.ScanCommand(stocksParams);
        const stocksResponse = await docClient.send(stocksCommand);
        const stocks = stocksResponse.Items;
        // Combine products with their stock information
        const products = productsResponse.Items;
        const productsWithStock = products.map(product => {
            const stockItem = stocks.find(stock => stock.product_id === product.id);
            return {
                ...product,
                count: stockItem ? stockItem.count : 0
            };
        });
        logger.info('Successfully retrieved products', {
            productCount: productsWithStock.length
        });
        metrics.addMetric('productsReturned', metrics_1.MetricUnit.Count, productsWithStock.length);
        return createResponse(200, productsWithStock);
    }
    catch (error) {
        logger.error('Error getting products list', {
            error: error.message,
            errorName: error.name,
            stackTrace: error.stack
        });
        metrics.addMetric('productsListErrors', metrics_1.MetricUnit.Count, 1);
        return createResponse(500, {
            message: 'Internal server error while fetching products',
            error: process.env.IS_OFFLINE ? error.message : 'Internal server error'
        });
    }
    finally {
        metrics.publishStoredMetrics();
    }
};
exports.handler = handler;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJpbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFBQSwwREFBdUQ7QUFDdkQsNERBQXFFO0FBQ3JFLDhEQUEwRDtBQUMxRCx3REFHK0I7QUFLL0IsTUFBTSxNQUFNLEdBQUcsSUFBSSxlQUFNLENBQUM7SUFDeEIsV0FBVyxFQUFFLGdCQUFnQjtJQUM3QixRQUFRLEVBQUUsTUFBTTtDQUNqQixDQUFDLENBQUM7QUFFSCxNQUFNLE9BQU8sR0FBRyxJQUFJLGlCQUFPLENBQUM7SUFDMUIsU0FBUyxFQUFFLGFBQWE7SUFDeEIsV0FBVyxFQUFFLGdCQUFnQjtJQUM3QixpQkFBaUIsRUFBRTtRQUNqQixXQUFXLEVBQUUsT0FBTyxDQUFDLEdBQUcsQ0FBQyxXQUFXLElBQUksYUFBYTtLQUN0RDtDQUNGLENBQUMsQ0FBQztBQUVILE1BQU0sTUFBTSxHQUFHLElBQUksZ0NBQWMsQ0FBQztJQUNoQyxNQUFNLEVBQUUsT0FBTyxDQUFDLEdBQUcsQ0FBQyxNQUFNO0NBQzNCLENBQUMsQ0FBQztBQUVILE1BQU0sU0FBUyxHQUFHLHFDQUFzQixDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQztBQU10RCxNQUFNLGNBQWMsR0FBRyxDQUFDLFVBQWtCLEVBQUUsSUFBUyxFQUFFLEVBQUUsQ0FBQyxDQUFDO0lBQ3pELFVBQVU7SUFDVixPQUFPLEVBQUU7UUFDUCw2QkFBNkIsRUFBRSxHQUFHO1FBQ2xDLGtDQUFrQyxFQUFFLElBQUk7S0FDekM7SUFDRCxJQUFJLEVBQUUsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUM7Q0FDM0IsQ0FBQyxDQUFDO0FBRUksTUFBTSxPQUFPLEdBQUcsS0FBSyxFQUFFLEtBQVUsRUFBRSxFQUFFO0lBQzFDLE1BQU0sQ0FBQyxVQUFVLENBQUMsS0FBSyxDQUFDLENBQUM7SUFFekIsSUFBSSxDQUFDO1FBQ0gsTUFBTSxDQUFDLElBQUksQ0FBQyx1QkFBdUIsRUFB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O0lBQ0wsQ0FBQztZQUFTLENBQUM7UUFDVCxPQUFPLENBQUMsb0JBQW9CLEVBQUUsQ0FBQztJQUNqQyxDQUFDO0FBQ0gsQ0FBQyxDQUFDO0FBaEVXLFFBQUEsT0FBTyxXQWdFbEIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBMb2dnZXIgfSBmcm9tICdAYXdzLWxhbWJkYS1wb3dlcnRvb2xzL2xvZ2dlcic7XG5pbXBvcnQgeyBNZXRyaWNzLCBNZXRyaWNVbml0IH0gZnJvbSAnQGF3cy1sYW1iZGEtcG93ZXJ0b29scy9tZXRyaWNzJztcbmltcG9ydCB7IER5bmFtb0RCQ2xpZW50IH0gZnJvbSBcIkBhd3Mtc2RrL2NsaWVudC1keW5hbW9kYlwiO1xuaW1wb3J0IHtcbiAgRHluYW1vREJEb2N1bWVudENsaWVudCxcbiAgU2NhbkNvbW1hbmRcbn0gZnJvbSBcIkBhd3Mtc2RrL2xpYi1keW5hbW9kYlwiO1xuXG5pbXBvcnQge1N0b2NrfSBmcm9tIFwiLi4vLi4vdHlwZXMvU3RvY2tzXCI7XG5pbXBvcnQge1Byb2R1Y3R9IGZyb20gXCIuLi8uLi90eXBlcy9Qcm9kdWN0c1wiO1xuXG5jb25zdCBsb2dnZXIgPSBuZXcgTG9nZ2VyKHtcbiAgc2VydmljZU5hbWU6ICdwcm9kdWN0U2VydmljZScsXG4gIGxvZ0xldmVsOiAnSU5GTydcbn0pO1xuXG5jb25zdCBtZXRyaWNzID0gbmV3IE1ldHJpY3Moe1xuICBuYW1lc3BhY2U6ICdQcm9kdWN0c0FwcCcsXG4gIHNlcnZpY2VOYW1lOiAncHJvZHVjdFNlcnZpY2UnLFxuICBkZWZhdWx0RGltZW5zaW9uczoge1xuICAgIGVudmlyb25tZW50OiBwcm9jZXNzLmVudi5FTlZJUk9OTUVOVCB8fCAnZGV2ZWxvcG1lbnQnXG4gIH1cbn0pO1xuXG5jb25zdCBjbGllbnQgPSBuZXcgRHluYW1vREJDbGllbnQoe1xuICByZWdpb246IHByb2Nlc3MuZW52LlJFR0lPTlxufSk7XG5cbmNvbnN0IGRvY0NsaWVudCA9IER5bmFtb0RCRG9jdW1lbnRDbGllbnQuZnJvbShjbGllbnQpO1xuXG5pbnRlcmZhY2UgUHJvZHVjdFdpdGhTdG9jayBleHRlbmRzIFByb2R1Y3Qge1xuICBjb3VudDogbnVtYmVyO1xufVxuXG5jb25zdCBjcmVhdGVSZXNwb25zZSA9IChzdGF0dXNDb2RlOiBudW1iZXIsIGJvZHk6IGFueSkgPT4gKHtcbiAgc3RhdHVzQ29kZSxcbiAgaGVhZGVyczoge1xuICAgICdBY2Nlc3MtQ29udHJvbC1BbGxvdy1PcmlnaW4nOiAnKicsXG4gICAgJ0FjY2Vzcy1Db250cm9sLUFsbG93LUNyZWRlbnRpYWxzJzogdHJ1ZSxcbiAgfSxcbiAgYm9keTogSlNPTi5zdHJpbmdpZnkoYm9keSlcbn0pO1xuXG5leHBvcnQgY29uc3QgaGFuZGxlciA9IGFzeW5jIChldmVudDogYW55KSA9PiB7XG4gIGxvZ2dlci5hZGRDb250ZXh0KGV2ZW50KTtcblxuICB0cnkge1xuICAgIGxvZ2dlci5pbmZvKCdHZXR0aW5nIHByb2R1Y3RzIGxpc3QnLCB7XG4gICAgICBvcGVyYXRpb246ICdnZXRQcm9kdWN0c0xpc3QnXG4gICAgfSk7XG4gICAgbWV0cmljcy5hZGRNZXRyaWMoJ2dldFByb2R1Y3RzTGlzdEludm9jYXRpb25zJywgTWV0cmljVW5pdC5Db3VudCwgMSk7XG5cbiAgICAvLyBHZXQgYWxsIHByb2R1Y3RzXG4gICAgY29uc3QgcHJvZHVjdHNQYXJhbXMgPSB7XG4gICAgICBUYWJsZU5hbWU6IHByb2Nlc3MuZW52LlBST0RVQ1RTX1RBQkxFLFxuICAgIH07XG5cbiAgICBjb25zdCBwcm9kdWN0c0NvbW1hbmQgPSBuZXcgU2NhbkNvbW1hbmQocHJvZHVjdHNQYXJhbXMpO1xuICAgIGNvbnN0IHByb2R1Y3RzUmVzcG9uc2UgPSBhd2FpdCBkb2NDbGllbnQuc2VuZChwcm9kdWN0c0NvbW1hbmQpO1xuXG4gICAgaWYgKCFwcm9kdWN0c1Jlc3BvbnNlLkl0ZW1zIHx8IHByb2R1Y3RzUmVzcG9uc2UuSXRlbXMubGVuZ3RoID09PSAwKSB7XG4gICAgICBsb2dnZXIuaW5mbygnTm8gcHJvZHVjdHMgZm91bmQnKTtcbiAgICAgIG1ldHJpY3MuYWRkTWV0cmljKCdlbXB0eVByb2R1Y3RzTGlzdCcsIE1ldHJpY1VuaXQuQ291bnQsIDEpO1xuICAgICAgcmV0dXJuIGNyZWF0ZVJlc3BvbnNlKDIwMCwgW10pO1xuICAgIH1cblxuICAgIC8vIEdldCBhbGwgc3RvY2tzXG4gICAgY29uc3Qgc3RvY2tzUGFyYW1zID0ge1xuICAgICAgVGFibGVOYW1lOiBwcm9jZXNzLmVudi5TVE9DS1NfVEFCTEUsXG4gICAgfTtcblxuICAgIGNvbnN0IHN0b2Nrc0NvbW1hbmQgPSBuZXcgU2NhbkNvbW1hbmQoc3RvY2tzUGFyYW1zKTtcbiAgICBjb25zdCBzdG9ja3NSZXNwb25zZSA9IGF3YWl0IGRvY0NsaWVudC5zZW5kKHN0b2Nrc0NvbW1hbmQpO1xuICAgIGNvbnN0IHN0b2NrcyA9IHN0b2Nrc1Jlc3BvbnNlLkl0ZW1zIGFzIFN0b2NrW107XG5cbiAgICAvLyBDb21iaW5lIHByb2R1Y3RzIHdpdGggdGhlaXIgc3RvY2sgaW5mb3JtYXRpb25cbiAgICBjb25zdCBwcm9kdWN0cyA9IHByb2R1Y3RzUmVzcG9uc2UuSXRlbXMgYXMgUHJvZHVjdFtdO1xuICAgIGNvbnN0IHByb2R1Y3RzV2l0aFN0b2NrOiBQcm9kdWN0V2l0aFN0b2NrW10gPSBwcm9kdWN0cy5tYXAocHJvZHVjdCA9PiB7XG4gICAgICBjb25zdCBzdG9ja0l0ZW0gPSBzdG9ja3MuZmluZChzdG9jayA9PiBzdG9jay5wcm9kdWN0X2lkID09PSBwcm9kdWN0LmlkKTtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIC4uLnByb2R1Y3QsXG4gICAgICAgIGNvdW50OiBzdG9ja0l0ZW0gPyBzdG9ja0l0ZW0uY291bnQgOiAwXG4gICAgICB9O1xuICAgIH0pO1xuXG4gICAgbG9nZ2VyLmluZm8oJ1N1Y2Nlc3NmdWxseSByZXRyaWV2ZWQgcHJvZHVjdHMnLCB7XG4gICAgICBwcm9kdWN0Q291bnQ6IHByb2R1Y3RzV2l0aFN0b2NrLmxlbmd0aFxuICAgIH0pO1xuICAgIG1ldHJpY3MuYWRkTWV0cmljKCdwcm9kdWN0c1JldHVybmVkJywgTWV0cmljVW5pdC5Db3VudCwgcHJvZHVjdHNXaXRoU3RvY2subGVuZ3RoLCApO1xuXG4gICAgcmV0dXJuIGNyZWF0ZVJlc3BvbnNlKDIwMCwgcHJvZHVjdHNXaXRoU3RvY2spO1xuXG4gIH0gY2F0Y2ggKGVycm9yOiBhbnkpIHtcbiAgICBsb2dnZXIuZXJyb3IoJ0Vycm9yIGdldHRpbmcgcHJvZHVjdHMgbGlzdCcsIHtcbiAgICAgIGVycm9yOiBlcnJvci5tZXNzYWdlLFxuICAgICAgZXJyb3JOYW1lOiBlcnJvci5uYW1lLFxuICAgICAgc3RhY2tUcmFjZTogZXJyb3Iuc3RhY2tcbiAgICB9KTtcbiAgICBtZXRyaWNzLmFkZE1ldHJpYygncHJvZHVjdHNMaXN0RXJyb3JzJywgTWV0cmljVW5pdC5Db3VudCwgMSk7XG5cbiAgICByZXR1cm4gY3JlYXRlUmVzcG9uc2UoNTAwLCB7XG4gICAgICBtZXNzYWdlOiAnSW50ZXJuYWwgc2VydmVyIGVycm9yIHdoaWxlIGZldGNoaW5nIHByb2R1Y3RzJyxcbiAgICAgIGVycm9yOiBwcm9jZXNzLmVudi5JU19PRkZMSU5FID8gZXJyb3IubWVzc2FnZSA6ICdJbnRlcm5hbCBzZXJ2ZXIgZXJyb3InXG4gICAgfSk7XG4gIH0gZmluYWxseSB7XG4gICAgbWV0cmljcy5wdWJsaXNoU3RvcmVkTWV0cmljcygpO1xuICB9XG59O1xuIl19